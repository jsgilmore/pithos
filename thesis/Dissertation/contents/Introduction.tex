\chapter{Introduction}
\label{chp:INTRO}

\section{MMOGs: The cost of doing business}
Massively Multiplayer Online Games (MMOGs) are characterised by thousands of players interacting in the same virtual environment or game world; socially, cooperatively or competitively. A popular MMOG genre is the MMO role playing game (MMORPG). In an MMORPG, players are represented by avatars that inhabit a virtual world. In this virtual world there are quests that a player may undertake to gain experience in classic RPG style. Gaining experience allows a player to gain levels, which makes the player character more powerful.

Players play the game to become sufficiently powerful to play the end-game content. End-game content requires large groups of players to work together in a highly coordinated way to achieve some set of objectives. This activity is called ``raiding''. Raiding is usually done by groups of players that have decided to play together and form a guild. Guilds have complex social structures, which allows for various social interactions. Usually it is this high degree of social interaction that attracts players to MMOGs. Players are no longer playing by themselves in a lonely world, but rather playing with other players in a large open virtual world.

Massively Multiplayer Online Games (MMOGs) have seen tremendous growth over the past decade, growing from less than 500,000 active subscribers in 1999 to over 21 million in 2011 \cite{mmo_growth_chart}. In 2011, the MMOG market was a \$2,6 billion industry in the United States alone \cite{newzoo_mmo_report}.

With the fast growing MMOG market, many companies are spending a significant amount of money to produce AAA MMOG titles. Some development cost estimates are: \$18 mil. for Aion, \$20 mil., for Everquest \cite{aion_everquest_cost}, \$63 mil. for World of Warcraft \cite{wow_cost} and \$100 mil. to \$200 mil. for Star Wars: The Old Republic \cite{star_wars_cost_1}, \cite{star_wars_cost_2}. Although these figures are purely estimates, it does show that to develop a AAA MMOG title costs a lot of money.

The issue with MMOG development is that, although they cost more to develop than single player or smaller scale multiplayer games, they are just as likely to fail. Despite this, game publishers are spending a lot of money in an attempt to recreate the success that is World of Warcraft.

Because of the large revenues being generated from MMOGs, many competitors are entering the MMOG space. Currently, the rate at which new MMOGs are added to the market is outstripping the growth of the market itself \cite{newzoo_mmo_report}. Furthermore, because of the recession, over the past two or three years, game subscriptions have been shown to stabilise or even decline \cite{mmo_growth_chart}.

The significant initial investment required to develop an MMOG also doesn't present the complete picture. Another factor driving up costs for an MMOG is the money required for server hardware, maintenance and support. An MMOG is not finished when it goes live. A team of developers is required to maintain the game, release patches fixing bugs and to produce more content to keep the player base sufficiently interested to ensure that players will continue to pay \$15 per month to play the game. Development and maintenance costs for World of Warcraft for four years is estimated at \$100 mil. to \$200 mil. \cite{wow_cost}.

With the costs involved, it is therefore difficult for a new developer to enter into this space. After the large initial investment into the game's development, all server hardware must be acquired and people appointed to maintain the game. This money has to be spent before it is known whether the game will succeed or fail. It has been estimated that during the lifetime of an MMOG, 80\% of the game revenue goes into hardware and maintenance costs \cite{cs_mmog_cost}.

In order to reduce the costs associated with classic MMOGs, peer-to-peer (P2P) MMOGs are being investigated. The challenges of P2P MMOGs provides the basis for this work.

\section{Peer-to-Peer systems}

A P2P system is a distributed network that exists out of many participating nodes to fulfil some objective. In this work, a P2P system is defined as being a distributed network with the following properties
\cite{Rodrigues_acm_comms_p2p}:
%
\begin{itemize}
\item \emph{High degree of decentralisation}:  No or little centralised control exists. Server functionality is distributed amongst all peers.
\item \emph{Self-organisation}: Little or no self-organisation is required in the network. Nodes are given an initial IP to allow them to join the network, but thereafter new neighbours are automatically acquired and nodes remain connected to the network, even with other nodes joining and leaving.
\item \emph{Multiple administrative domains} Peers are not under the control of any single authority. Peers in the network belong to different organisations or individuals and direct administration is impossible.
\end{itemize}

Peer-to-peer (P2P) systems have been popularised by mainly three systems developed in 1999: the Napster music sharing service, the Freenet data store and the SETI@home volunteer-based distributed computing project. These three projects highlighted the advantages of P2P systems being: low barrier to entry, scalability, resistance to faults and attacks, and an abundance and availability of resources.

\subsection{Advantages}

P2P systems have a low barrier to entry, since little or no centralised infrastructure is required to maintain the system. This makes P2P systems inexpensive to operate and is one of the reasons Napster was able to provide its service for free.

P2P systems are considered scalable. Pure P2P networks can theoretically grow from hundreds to millions of nodes, with the service remaining functional. And this is all possible without the need for the operator to acquire more infrastructure. This is as opposed to the centralised client/server network, which required more powerful server clusters are the network grows to handle the growing number of client requests.

A P2P system is also resistant to faults and attacks, since the failure of a single node has little to no effect on the network. This is because there are usually few nodes that are critical to the correct functionality of the system. To shut down a P2P system, an attacker usually has to shut down a large proportion of the network.

Not only does a P2P operator not require its own infrastructure, but the P2P infrastructure that forms part of the network and consists of peer machines provide abundant and highly available resources, being computation power, long term and short term storage. This means that P2P systems can be designed to run on powerful computers.

\subsection{Structured and unstructured P2P overlay networks}
\label{overlays}

P2P networks are created and maintained in the application layer of the Open Systems Interconnection (OSI) model protocol stack. This application
layer network is called the P2P overlay. Peers in an overlay network might have neighbours that have no relationship to their physical position in
the underlying network. Overlays can broadly be classified into structured and unstructured types. The classification is mostly based on the
differing methods of routing and content retrieval in the network. This section only provides a brief comparison between structured and unstructured overlays. For a detailed comparison between the two types that also deals with many of the myths of structured overlays, please refer to
\cite{Castro_structured_overlay_myths}.

With unstructured approaches, one is never assured that a data item will be retrieved, even if that data item is present in the network. If many
duplicates of a data item are contained in the network, this becomes less of a problem, since it is assumed that the request will be routed to some
set of nodes that do  possess the item.

An unstructured architecture works well for content sharing and Voice over Internet Protocol (VoIP) networks, for example: P2P TV, BitTorrent,
Gnutella and Skype. The reason for this is the high level of duplication in these networks, especially for popular content. It is also easier to
perform keyword searches in unstructured networks and the overlay requires less maintenance.

Because there is no assurance that a data item might be retrieved from an unstructured network, especially when that item is scarce, unstructured
overlays are not considered adequate as a basis for P2P MMVEs, where all data items must be available at all times.

Structured overlays have been proposed that provide for efficient routing and reliable retrieval of data items. Some of these well known overlays
are: CAN \cite{CAN}, Chord \cite{chord}, Tapestry \cite{tapestry} and Pastry \cite{pastry}.

The basic idea of a structured overlay is that all nodes are identified by unique identifiers (IDs). A popular method to create the IDs is to use
hashes to a circular key space. Any node in the overlay network is then able to efficiently route a query with a given ID, to a node with an ID
closest to the given ID. An accurate comparison is that unstructured overlays are good at finding ``hay'', while structured overlays are good at
finding ``needles'' \cite{Rodrigues_acm_comms_p2p}.

%TODO: Add something about the effect of the hashing and why it's important

\section{Peer-to-Peer MMVE network architectures}
\label{p2p_network_architectures}

P2P MMOGs are considered a sub-class of P2P Massively Multiuser Virtual Environments (MMVEs), a class that also includes large scale military simulators.

In 2004, an architecture using the peer-to-peer networking model to host MMVEs was proposed by Knutsson et al. \cite{knutsson_p2p_first}. This
revealed a new research field, which attempts to establish the P2P model as a viable alternative to the classic C/S and Client/MultiServer (C/MS)
architectures. This architecture does, however, still have a few major issues that need to be solved before MMVEs can be developed that use it. If
these issues, discussed in Section \ref{key_challenges}, can be solved, a P2P architecture holds some powerful advantages over a C/S system.

The core idea of the P2P model is that each peer contributes sufficient resources to the network to host itself. This also means that all functions
of the server in the classic C/S model are distributed amongst all peers.

\subsection{Advantages}
\label{p2p_advantages}

There are various advantages to moving from C/S to P2P in MMVEs. These include: increased robustness, improved scalability, lower operator costs,
improved handling of transient player load and lower latencies.

The P2P system is robust, because there is no server that can fail, only individual peers. Individual peers failing will not affect any other peers
other than the peer that failed. This behaviour makes game down-time extremely unlikely.

Furthermore, because every peer hosts itself, the system is scalable. Another advantage is that no extra costs are incurred from an operator
perspective, when more peers join the network. This will also allow for efficient handling of transient loads. If many players suddenly enter the
game no resource provisioning issues will arise, since peers already possess their required resources.

P2P architectures also create a lot of opportunity for independent developers, because a large initial investment is no longer required to purchase
the expensive server hardware. Not only are hardware costs reduced, but running costs are also reduced. The bandwidth required by the game server is
now shared amongst users, which means that very little bandwidth costs will be incurred by the provider.

Latency is also improved, because it is now possible to directly communicate between peers and it is not necessary to communicate via a server. There
is also no single server that has to process user actions (events). User actions need only be processed by other peers who find the specific action of interest. The distribution of the load as well as direct communication will further reduce latency.

\subsection{Key challenges}
\label{key_challenges}
Although many advantages can be had from P2P MMVEs, some challenges still remain. The main challenges are state consistency, limited peer bandwidth, cheating mitigation, incentive mechanisms and distributed computation.

\subsubsection{Peer bandwidth}
Another challenge for P2P systems is the required peer bandwidth. In a paper by Miller and Crowcroft, a packet simulator was created to determine the
required bandwidth and effective latency, if a game such as World of Warcraft were to be implemented using P2P technologies
\cite{Miller_p2p_infeasability}. Their simulation results indicate that today's networks are not able to host P2P MMVEs, with the required bandwidth
and latency constraints. Such a significant result requires verification, but at the least, it shows that reducing bandwidth and latencies for P2P
MMVEs should be a primary design requirement.

\subsubsection{Cheating mitigation}
\label{key_challenges_cheating}

Cheating mitigation has been identified as a major issue for P2P systems \cite{knutsson_p2p_first}, \cite{challenges_p2p_gaming},
\cite{cheat_proof_event_ordering}. The challenges reside in the fact that peers are not under the control of the game producer. Since all server data
are distributed amongst peers, all peers have access to sections of the server data. Peers also have access to the distributed server code. One
advantage that can be exploited to prevent cheating is that no peer contains all server data and no single peer has more authority than another.

There are various security issues that are usually classified according to the level in the protocol stack where they occur. The areas identified by
\cite{cheat_proof_event_ordering} and expanded upon by \cite{cheating_taxonomy} are: game level, application level, protocol level and infrastructure level. This is consistent with the generally used layered security model \cite{distributed_systems_security}.

Game level cheats are ways in which a malicious player may gain an unfair advantage over other players, within the confines of the game. These cheats are usually because of software bugs and some examples are duplication and teleport cheats.

Application level cheats are where malicious players alter the game software to gain an unfair advantage. This is usually done by gaining access to
the game state to which they should not have access at the current time. An example of this is ``map reveal'' cheats in strategy games. Where the
``fog of war'' is removed and the player can observe all the opponent's movements. Other cheats are sometimes used that augment the player's UI with extra information that allows the player to make more informed decisions. It is debatable whether these additions are cheats. They are, however, considered almost essential for competitive WoW play.

Protocol level cheats are cheats based on the different methods of communicating data across the system. These usually concern dropping, delaying of modifying IP packets to achieve certain outcomes in the game. Infrastructure level cheats concern exploiting the underlying infrastructure on which the games are built. These include hacking the hardware or P2P overlay.

As with all taxonomies, all cheats may not cleanly fit into one if these boxes, some cheats may occur over multiple levels or a cheat with a specific outcome can be implemented differently on different levels. The field of P2P security has recently received more attention than in the past and has
started to bear fruit \cite{survey_p2p_game_cheats}. This is, however, an ongoing research field with many issues still open. For an in-depth review
of the security issues facing peer-to-peer system in general, refer to \cite{p2p_security_issues}. These issues are the same issues facing P2P MMVEs, with the exception of the game and application layer issues.

\subsubsection{Incentive mechanisms}

P2P schemes require all players to share resources in order to ensure correct functionality. The issue with this is that players might not want to share their resources, but still benefit from the resources of others. This is where incentive mechanisms become important. The function of these
mechanisms is to ensure that all players contribute resources, by incentivised contribution.

All distributed resource sharing models require incentive mechanisms. For example, Bittorrent systems use the tit-for-tat protocol to ensure that all
people downloading data are also contributing data \cite{tit_for_tat}. Such mechanisms are also required with P2P MMVEs. One advantage in designing
an incentive algorithm for a P2P MMVE is that players can be made to contribute resources for the duration of play. The issues with file sharing
systems are not present where a peer, after downloading a file, has no more incentive to contribute. When a peer plays a game, incentive can be
created to provide resources for the duration of the game.

Some incentive schemes proposed increase a player's reputation when resources are provided \cite{classic_p2p_reputation} \cite{proactive_reputation}. This might create a type of meta game, where players try to gain as much reputation as possible. It can however be argued that this scheme does not really enforce the provisioning of resources. A player who does not want to provide resources might not see a higher reputation as sufficient incentive to provide resources.

Other issues with incentive schemes is that sometimes players might have insufficient resources. Such players should be aided by other players with
sufficient resources and not be disallowed to play the game. When limited resources are taken into account, the issue of reporting a false amount of
available resources becomes a problem. A peer that has sufficient resources, might report insufficient resources, to not be penalised. It is evident
that there exists space for more research in this field.


\subsubsection{Distributed computation}

Non-Player Characters (NPCs) are characters that are not controlled by any human player, but are rather controlled by some artificial intelligence
routine or script executing on some host machine. These characters represent the traders and monsters in MMVEs and usually contain sets of rules that
determine how they should interact with Player Characters (PCs) as well as their own state information. An NPC's state can be how much money and
items it has to trade or how much health it still has after being attacked by a player.

In the original NPC host allocation classification by Fan, both NPC state and computational routines are combined into a single category
\cite{Fan_phd}. In the classification presented below, NPC state forms part of normal game state persistency, since NPC objects are game objects like
any other. The NPC routines requiring computational power are grouped under the heading of distributed computation. This heading is meant to include
the distribution of all in game computational elements.

Some game objects require computational power to function. An example of this is the Artificial Intelligence routines of NPCs or the computation of
physics effects on in-game objects. Some architectures assume that the computational requirements will be fulfilled where the object state is hosted
\cite{solipsis}, but other schemes exist that allow for the CPU power to be distributed amongst peers. One such scheme makes use of a ``job board''
like mechanism, where tasks are advertised on specialised super peers. Other peers monitor these super peers and may elect to perform the advertised
tasks \cite{fan_mediator_paper}.

\subsubsection{State consistency}
%State persistency, compared to state consistency
A key challenge with any networked game is how to maintain state consistency between users in the virtual world. In other words, to ensure that all users perceive a virtual world in the same state. Solving the state consistency problem for P2P MMVEs is one of the major development challenges and forms the focus of this work. The challenge of state consistency will be described in detail in Chapter \ref{chp:CONSISTENCY}.

\section{Objectives and contributions}
\label{objectives}

The main objective of this work is to advance the state of the art of P2P MMVEs. Early in the literature study phase, it was discovered that no research projects that deal with P2P MMVEs present the complete picture of the field. A significant amount of research has been done in the field of state consistency (reviewed in Chapter \ref{chp:CONSISTENCY}), but in this field, no model has been provided which shows what is required to build a complete state consistency architecture. The first contribution of this work is to provide such an architecture at the start of Chapter \ref{chp:CONSISTENCY}.

The generic consistency model that is developed is not only applicable to P2P MMVEs, but to any networked virtual environment that required state consistency. The generic consistency model is also compared with well known client/server and P2P consistency models, to show how the existing models can be seen as more specialised versions of the generic consistency model.

After developing a generic consistency model, this work then focusses on an area of state consistency that has received little attention from the research community, namely: state management and state persistency. This area is concerned with managing object states as they are updated by events occurring in the virtual environment. Also during a literature review of this field, it was found that no thorough review of this field has been done to compare the different types of storage systems present in P2P MMVEs and presented in the literature. We then preceded to perform such a review, presented in Chapter \ref{p2p_MMVE_state_persistency}. The results of this survey has also been published in the IEEE Transactions of Parallel and Distributed Systems \cite{gilmore_p2p_mmog_state_persistency}.

During the survey, some key metrics were identified by which state management and state persistency systems may be described. A proposal was also made as to how these metrics may be measured. What was found upon completion of the survey is that no storage system has thus far been created to satisfy all identified metrics. Work was then undertaken to develop a novel state management and persistency architecture that satisfies all identified requirements.

The state management and persistency architecture has been developed and called ``Pithos''. Pithos has been implemented in a network simulation framework, called Oversim, which runs on the Omnet++ simulation environment. The Oversim framework itself has also been extended to implement our novel generic consistency architecture. Pithos has been implemented in the root object store section of this architecture.

Many of the key mechanisms in Pithos, such as object retrieval, have been implemented using multiple methods. These methods are then compared to determine the advantages and disadvantages of each. Pithos is also compared to the storage systems identified. Pithos always shows similar or improved performance over classic storage systems in all identified areas.

In order to verify the correct functioning of Pithos, mathematical models are also developed to describe Pithos's performance in the various identified metrics. Amongst these is a novel Mathematical model that makes use of an embedded continuous time Markov chain to determine expected object lifetime for varying amounts of network churn, various network sizes and replication rate. The mathematical model is compared with actual Pithos results and appears to match almost exactly.

\section{Summary of this work}

Chapter \ref{chp:CONSISTENCY} presents an overview of state consistency models. Initially, it describes the general process by which state consistency is achieved. Some classic consistency models are then presented in terms of the generic model. Consistency models for P2P MMVEs are then presented, with an overview of work that has been done in each of the various sections required to implement a complete consistency model.

Chapter \ref{p2p_MMVE_state_persistency} focuses on the state management and state persistency aspect of P2P MMVE state consistency. Initially, some metrics are defined according to which different storage architecture may be compared. A literature review is then presented, where papers that deal with various storage techniques are grouped and the advantages and disadvantages of each group is then discussed. This chapter also identifies a need for a novel state management and persistency architecture.

Chapter \ref{chp:DESIGN} describes the design and implementation of Pithos, the novel state management and persistency architecture. Initially, the overarching Pithos design is described, including the perceived use case and design goals. The Oversim simulation environment is then described, along with the extensions that were made to model the generic consistency model. The Pithos implementation is then described in terms of Oversim modules. Key mechanisms that implement that Pithos design are then presented with reference to the Pithos Oversim modules. Various methods to implement some mechanisms are descried.

Chapter \ref{chp:EVALUATION} evaluates the Pithos implementation. The performance of the key mechanisms are presented and the various implementation methods are compared. Pithos is also compared with other storage implementations.

Chapter \ref{chp:MODELLING} models Pithos's performance with reference to the identified metrics for P2P MMVE storage systems. A focus is placed on expected object lifetime and a novel model is developed, based on an embedded continuous time Markov chain.

Chapter \ref{chp:VERIFICATION} compares model results with Pithos simulation results. The purpose of this chapter is to verify the correct functionality of Pithos, according to mathematical models. The chapter also explores how to design storage systems with desired object lifetimes.

Chapter \ref{chp:CONC} concludes the work. It presents a summary of the work, lists contributions made and discusses some future areas of research.
